<!-- fitnessapp/templates/fitnessapp/workout.html -->
{% extends 'fitnessapp/base.html' %}
{% load crispy_forms_tags %}
{% block content %}

<h2>Тренировка</h2>

<!-- Таймер -->
<div class="mb-3">
  <label><strong>Время тренировки:</strong></label>
  <!-- Сам таймер, цвет которого будет мигать при активном состоянии -->
  <span id="workout-timer" style="display:inline-block; width:70px; text-align:center; font-weight:bold; color:black;">0:00</span>

  <!-- Кнопка Start/Pause; делаем её крупнее -->
  <button class="btn btn-lg btn-success" id="start-pause-btn" style="margin-left:10px;">
    Start
  </button>
</div>

<form method="post" id="workout-form">
  {% csrf_token %}
  <!-- Скрытое поле для хранения длительности в минутах -->
  <input type="hidden" name="duration_minutes" id="duration-minutes" value="0">

  <!-- Поле для ввода веса (уменьшенное) -->
  <div class="mb-3">
    <label for="current_weight">Введите ваш текущий вес (кг):</label>
    <input type="number" step="0.1" class="form-control" name="current_weight"
           id="current_weight" value="0" style="max-width:180px;">
  </div>

  <h4>Упражнения</h4>
  <div id="exercises-container">
    <!-- Здесь динамически появляются упражнения -->
  </div>

  <!-- Кнопка добавления упражнения -->
  <button type="button" class="btn btn-primary" id="add-exercise-btn">Создать упражнение</button>

  <!-- Скрытое поле для подсчёта кол-ва упражнений -->
  <input type="hidden" name="exercise_count" id="exercise-count" value="0">

  <!-- Кнопка завершения тренировки -->
  <div class="mt-3">
    <button type="submit" class="btn btn-danger" >Завершить тренировку</button>
  </div>
</form>

<script>
   // -------------------------------
  // ТАЙМЕР + КНОПКА START/PAUSE
  // -------------------------------
  // Статусы: "stopped" | "running" | "paused"
  let status = "stopped";   // изначально таймер ещё не запущен
  let totalSeconds = 0;     // общее количество секунд
  const timerEl = document.getElementById('workout-timer');
  const startPauseBtn = document.getElementById('start-pause-btn');
  const durationInput = document.getElementById('duration-minutes');

  // Функция для обновления вида (цвет/текст) кнопки
  function updateButtonView() {
    if (status === "stopped") {
      // Ещё не запущен => зелёная кнопка, текст "Start"
      startPauseBtn.classList.remove('btn-warning');
      startPauseBtn.classList.add('btn-success');
      startPauseBtn.textContent = "Start";
    } else if (status === "running") {
      // Запущен => зелёная кнопка, текст "Pause"
      startPauseBtn.classList.remove('btn-warning');
      startPauseBtn.classList.add('btn-success');
      startPauseBtn.textContent = "Pause";
    } else if (status === "paused") {
      // Пауза => оранжевая кнопка, текст "Resume"
      startPauseBtn.classList.remove('btn-success');
      startPauseBtn.classList.add('btn-warning');
      startPauseBtn.textContent = "Resume";
    }
  }

  // Функция обновления текста таймера (MM:SS)
  function updateTimer() {
    let minutes = Math.floor(totalSeconds / 60);
    let seconds = totalSeconds % 60;
    let displayMins = minutes < 10 ? "0" + minutes : minutes;
    let displaySecs = seconds < 10 ? "0" + seconds : seconds;
    timerEl.textContent = displayMins + ":" + displaySecs;

    // В скрытом поле для формы храним общее кол-во минут (с точностью до сотых)
    durationInput.value = (totalSeconds / 60).toFixed(2);
  }

  // Запускаем интервал каждую секунду
  setInterval(() => {
    if (status === "running") {
      totalSeconds++;
      updateTimer();
    }
  }, 1000);

  // Каждые 300 мс мигаем цветом только если running
  let colorToggle = false;
  setInterval(() => {
    if (status === "running") {
      colorToggle = !colorToggle;
      timerEl.style.color = colorToggle ? 'red' : 'black';
    } else {
      // Приостановлен или не запущен — цвет чёрный
      timerEl.style.color = 'black';
    }
  }, 500);

  // При нажатии на кнопку меняем состояние
  startPauseBtn.addEventListener('click', () => {
    if (status === "stopped") {
      // Не запущен => запускаем
      status = "running";
    } else if (status === "running") {
      // Был запущен => ставим на паузу
      status = "paused";
    } else if (status === "paused") {
      // Была пауза => снова запускаем
      status = "running";
    }
    updateButtonView();
  });

  // При загрузке страницы сразу выставить правильное отображение
  updateButtonView();

  // -------------------------------
  // ДОБАВЛЕНИЕ УПРАЖНЕНИЙ
  // -------------------------------
  let exerciseCount = 0;
  const addExerciseBtn = document.getElementById('add-exercise-btn');
  const exercisesContainer = document.getElementById('exercises-container');
  const exerciseCountInput = document.getElementById('exercise-count');

  addExerciseBtn.addEventListener('click', () => {
    exerciseCount++;
    exerciseCountInput.value = exerciseCount;

    // Создаём div для блока упражнения
    let exDiv = document.createElement('div');
    exDiv.classList.add('row', 'mb-2');

    // Пример содержимого с селектом и полем ввода веса
    exDiv.innerHTML = 
      `<div class="col-2">
        <label>#${exerciseCount} ex</label>
      </div>
      <div class="col-5">
        <select class="form-select" name="exercise_type_${exerciseCount}">
          <option value="">Не выбрано</option>
          {% for et in exercise_types %}
          <option value="{{ et.id }}">{{ et.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-5">
        <input type="number" step="0.1" class="form-control" 
               name="exercise_weight_${exerciseCount}" placeholder="вес (кг)">
      </div>
    `;
    exercisesContainer.appendChild(exDiv);
  });
</script>

{% endblock content %}